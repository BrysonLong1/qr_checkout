{% extends "base.html" %}

{% block title %}Your Tickets – Teameventlock{% endblock %}

{% block extra_head %}
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card { background:#111; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.5); }
    .gbtn { background: linear-gradient(90deg, orange, deeppink); }
    .gbtn:hover { filter: brightness(1.05); }
    .range-track { appearance:none; height:6px; border-radius:6px; background:#2a2a2a; outline:none; }
    .range-thumb {
      appearance:none; width:18px; height:18px; border-radius:9999px;
      background: linear-gradient(90deg, orange, deeppink); border:none; cursor:pointer;
      box-shadow: 0 0 0 2px #111;
    }
    /* browsers */
    input[type="range"]::-webkit-slider-runnable-track { height:6px; border-radius:6px; background:#2a2a2a; }
    input[type="range"]::-webkit-slider-thumb { margin-top:-6px; width:18px; height:18px; border-radius:9999px;
      background: linear-gradient(90deg, orange, deeppink); border:none; box-shadow:0 0 0 2px #111; }
    input[type="range"]::-moz-range-track { height:6px; border-radius:6px; background:#2a2a2a; }
    input[type="range"]::-moz-range-thumb { width:18px; height:18px; border-radius:9999px;
      background: linear-gradient(90deg, orange, deeppink); border:none; box-shadow:0 0 0 2px #111; }
  </style>
{% endblock %}

{% block content %}
<div class="min-h-[70vh] flex items-start justify-center">
  <div class="w-full max-w-2xl card p-6 text-white">

    <div class="flex items-center justify-between">
      <h2 class="text-2xl font-bold">Your Event Tickets</h2>
      <button id="toggleForm"
              class="px-3 py-2 rounded-md bg-white text-black font-semibold"
              type="button">+ Add Ticket</button>
    </div>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="mt-4 bg-red-600/20 text-red-200 p-3 rounded">
          {% for m in messages %}<div>{{ m }}</div>{% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% if tickets and tickets|length > 0 %}
      <div class="mt-6">
        <label class="block text-sm text-gray-300 mb-2">Your Tickets ({{ tickets|length }}/5)</label>
        <div class="overflow-hidden rounded-lg border border-gray-800">
          <table class="w-full text-sm">
            <thead class="bg-black/40 text-gray-300">
              <tr>
                <th class="text-left px-4 py-2">Name</th>
                <th class="text-left px-4 py-2">Price</th>
                <th class="px-4 py-2"></th>
              </tr>
            </thead>
            <tbody>
              {% for t in tickets %}
              <tr class="border-t border-gray-800">
                <td class="px-4 py-2">{{ t.name }}</td>
                <td class="px-4 py-2">${{ '%.2f'|format(t.price|float) }}</td>
                <td class="px-4 py-2 text-right">
                  <form method="POST" action="{{ url_for('delete_ticket', ticket_id=t.id) }}"
                        onsubmit="return confirm('Delete ticket {{ t.name }}?')">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button class="px-3 py-1 rounded-md bg-gray-800 hover:bg-gray-700 text-gray-200"
                            type="submit">Delete</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="mt-4 text-right">
          <a href="{{ url_for('index') }}"
             class="inline-block px-4 py-2 rounded-md gbtn text-white font-semibold">Generate QR</a>
        </div>
      </div>
    {% else %}
      <p class="mt-6 text-red-400">You must add at least one ticket.</p>
    {% endif %}

    <!-- Add Ticket Form -->
    <div id="ticket-form" class="mt-8 hidden">
      <h3 class="text-lg font-semibold mb-3">Add a Ticket</h3>
      <form method="POST">
        {{ form.hidden_tag() }}

        <label class="block mb-2">{{ form.name.label }}</label>
        {{ form.name(class_="w-full px-3 py-2 rounded-md text-black", placeholder="General Admission") }}

        <label class="block mt-4 mb-2">{{ form.price.label }}</label>
        {{ form.price(class_="w-full px-3 py-2 rounded-md text-black", step="0.01", placeholder="20.00") }}

        <!-- Fee slider (5%–20%) + live split preview -->
        <div class="mt-5 border border-gray-800 rounded-xl p-4 bg-black/30">
          <p class="text-sm text-gray-300">
            Our platform aims to put venues in full control. That’s why <strong>you set the fee</strong> —
            we take half and <strong>you take the other half</strong>. Min 5%, Max 20%. <em>Recommended 12%.</em>
          </p>

          <div class="mt-3 flex items-center gap-3">
            <input type="range" id="feeRange" min="5" max="20" step="0.5"
                   value="{{ current_user.fee_percent or 12.0 }}"
                   class="w-full" style="appearance:none" oninput="updateFeeUI()">
            <div id="feeBadge" class="px-3 py-1 rounded-md bg-gray-900 border border-gray-800 text-sm">
              {{ '%.1f' % (current_user.fee_percent or 12.0) }}%
            </div>
          </div>

          <!-- hidden field actually submitted -->
          <input type="hidden" name="fee_percent_override" id="feeValue"
                 value="{{ current_user.fee_percent or 12.0 }}">

          <!-- live preview -->
          <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div class="border border-gray-800 rounded-lg p-3 bg-[#0f0f0f]">
              <div class="flex justify-between text-sm text-gray-300">
                <span>Base price</span><strong>$<span id="baseOut">0.00</span></strong>
              </div>
              <div class="flex justify-between text-sm text-gray-300 mt-1">
                <span>Fee (<span id="pctOut">0%</span>)</span><strong>$<span id="feeOut">0.00</span></strong>
              </div>
              <div class="flex justify-between mt-2 pt-2 border-t border-gray-800">
                <span>Total paid</span><strong>$<span id="totalOut">0.00</span></strong>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div class="border border-gray-800 rounded-lg p-3 bg-[#0f0f0f]">
                <div class="text-xs text-gray-300">Your share</div>
                <div class="text-sm"><strong>$<span id="venueOut">0.00</span></strong></div>
              </div>
              <div class="border border-gray-800 rounded-lg p-3 bg-[#0f0f0f]">
                <div class="text-xs text-gray-300">Platform share</div>
                <div class="text-sm"><strong>$<span id="platOut">0.00</span></strong></div>
              </div>
            </div>
          </div>
        </div>
        <!-- end fee slider block -->

        <div class="mt-5">
          {{ form.submit(class_="w-full py-2 rounded-md gbtn text-white font-semibold") }}
        </div>
      </form>
      <p class="text-xs text-gray-400 mt-2">Limit 5 tickets per account.</p>
    </div>

    <div class="mt-6">
      <a href="{{ url_for('index') }}" class="underline text-gray-300">← Back to Generate</a>
    </div>
  </div>
</div>

<script>
  const btn = document.getElementById('toggleForm');
  const form = document.getElementById('ticket-form');
  if (btn && form) {
    btn.addEventListener('click', () => {
      const showing = !form.classList.contains('hidden');
      form.classList.toggle('hidden');
      btn.textContent = showing ? '+ Add Ticket' : '× Close';
      if (!showing) {
        const input = form.querySelector('input[name="{{ form.name.name }}"]');
        if (input) input.focus();
        updateFeeUI();
      }
    });
  }

  // Fee UI
  const priceInput = document.querySelector('input[name="{{ form.price.name }}"]');
  const feeRange   = document.getElementById('feeRange');
  const feeBadge   = document.getElementById('feeBadge');
  const feeValue   = document.getElementById('feeValue');

  const baseOut  = document.getElementById('baseOut');
  const pctOut   = document.getElementById('pctOut');
  const feeOut   = document.getElementById('feeOut');
  const totalOut = document.getElementById('totalOut');
  const venueOut = document.getElementById('venueOut');
  const platOut  = document.getElementById('platOut');

  function clampPct(x){ return Math.max(5, Math.min(20, x)); }
  function toMoney(n){ return (isFinite(n) ? n : 0).toFixed(2); }

  function updateFeeUI(){
    if (!priceInput || !feeRange) return;
    const base = parseFloat(priceInput.value || "0") || 0;
    const pct  = clampPct(parseFloat(feeRange.value || "12") || 12);

    feeBadge.textContent = pct.toFixed(1) + '%';
    feeValue.value = pct.toFixed(1);
    pctOut.textContent = pct.toFixed(1) + '%';

    const fee   = base * (pct / 100.0);
    const total = base + fee;

    const platformShare = fee / 2.0;
    const venueShare    = total - platformShare; // base + fee/2

    baseOut.textContent  = toMoney(base);
    feeOut.textContent   = toMoney(fee);
    totalOut.textContent = toMoney(total);
    venueOut.textContent = toMoney(venueShare);
    platOut.textContent  = toMoney(platformShare);
  }

  priceInput?.addEventListener('input', updateFeeUI);
  feeRange?.addEventListener('input', updateFeeUI);
  updateFeeUI();
</script>
{% endblock %}
