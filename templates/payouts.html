{% extends "base.html" %}
{% block title %}Connect Payouts – Teameventlock{% endblock %}

{% block content %}
<style>
  :root{ --ok:#31d0aa; --err:#ff6b6b; }
  .wrap-payouts{
    min-height:70vh; display:flex; align-items:center; justify-content:center; padding:24px;
  }
  .card{
    width:100%; max-width:520px; background:#111; color:#fff;
    padding:28px; border-radius:14px; box-shadow:0 10px 30px rgba(0,0,0,.5); text-align:center;
  }
  .card .logo{ width:220px; max-width:80%; height:auto; display:block; margin:0 auto 10px; }
  h1{ font-size:26px; margin:8px 0 6px; font-weight:700; }
  p.desc{ font-size:14px; color:#b3b3b3; margin:0 0 18px; line-height:1.5; }
  .row{ display:grid; gap:10px; grid-template-columns:1fr; }
  .btn{
    width:100%; padding:12px 16px; border-radius:10px; border:none; cursor:pointer; font-weight:700; font-size:16px;
    color:#fff; background:#2a2a2a;
  }
  .btn.primary{ background:linear-gradient(90deg, orange, deeppink); }
  .btn:active{ transform:translateY(1px); }
  .status{ margin-top:12px; font-size:14px; color:#b3b3b3; }
  .status.ok{ color:var(--ok); }
  .status.err{ color:var(--err); }
  .hint{ font-size:12px; color:#b3b3b3; margin-top:6px; }
  .hr{ height:1px; background:#222; margin:18px 0; }
</style>

<div class="wrap-payouts">
  <div class="card">
    <img class="logo" src="{{ url_for('static', filename='thelogo.png') }}" alt="Teameventlock" />
    <h1>Connect Payouts</h1>
    <p class="desc">
      Set up Stripe Express to receive your money. When onboarding is complete,
      the <strong>Next</strong> button unlocks and takes you to your tickets & QR page.
    </p>

    <div class="row">
      <button class="btn primary" id="setupBtn">Set up payouts with Stripe</button>
      <button class="btn" id="reauthBtn">Resume onboarding</button>
      <button class="btn" id="dashBtn">Open Stripe Dashboard</button>
    </div>

    <div class="hr"></div>

    <button class="btn primary" id="nextBtn" disabled>Next → Tickets</button>
    <div id="status" class="status">Checking account status…</div>
    <div class="hint">If you just finished onboarding in another tab, this page will auto-detect it within a few seconds.</div>
  </div>
</div>

<script>
  const statusEl = document.getElementById('status');
  const nextBtn  = document.getElementById('nextBtn');
  const setupBtn = document.getElementById('setupBtn');
  const reauthBtn= document.getElementById('reauthBtn');
  const dashBtn  = document.getElementById('dashBtn');

  function setStatus(text, cls=''){
    statusEl.className = 'status ' + cls;
    statusEl.textContent = text;
  }

  async function checkStatus(){
    try{
      const r = await fetch('/api/connect/status', {credentials:'same-origin'});
      const j = await r.json();
      if(j.ready){
        nextBtn.disabled = false;
        setStatus('Stripe connected ✓ charges enabled', 'ok');
      }else{
        nextBtn.disabled = true;
        setStatus(j.reason === 'no_account'
          ? 'No Stripe account yet — click “Set up payouts”.'
          : 'Not ready yet — finish onboarding in Stripe, then return here.');
      }
    }catch(e){
      nextBtn.disabled = true;
      setStatus('Could not check status. Try refresh.', 'err');
    }
  }

  checkStatus();
  let polls = 0;
  const iv = setInterval(() => { polls++; checkStatus(); if (polls > 24) clearInterval(iv); }, 5000);

  setupBtn.onclick = async () => {
    try{
      setStatus('Creating onboarding link…');
      const r = await fetch('/api/connect/create-account', {method:'POST', credentials:'same-origin'});
      const j = await r.json();
      if(!r.ok || !j.url) throw new Error(j.error || 'Failed to create link');
      window.location = j.url;
    }catch(e){
      setStatus('Error starting onboarding: ' + e.message, 'err');
    }
  };

  reauthBtn.onclick = () => { window.location = '/connect/reauth'; };

  dashBtn.onclick = async () => {
    try{
      setStatus('Opening Express Dashboard…');
      const r = await fetch('/api/connect/dashboard', {method:'POST', credentials:'same-origin'});
      const j = await r.json();
      if(!r.ok || !j.url) throw new Error(j.error || 'Not available yet');
      window.location = j.url;
    }catch(e){
      setStatus('Dashboard unavailable until onboarding finishes.', 'err');
    }
  };

  nextBtn.onclick = () => { window.location = '/'; };
</script>
{% endblock %}
